function InitTables(){$("table.sortable").each(function(n,t){InitSortableTable($(t))});$("table.api-source").each(function(n,t){RefreshTable($(t))})}function RefreshTable(n){var t=n.attr("data-url"),i=n.data("method");t&&i&&$.ajax({url:t,method:i,success:function(t){FillTable(n,t)}})}function FillTable(n,t){var i=$(n.children("tbody"));i.length==0&&(i=$("<tbody />"),n.append(i));i.empty();$(t).each(function(t,r){var u=$("<tr data-source='"+JSON.stringify(r)+"'/>");n.find("th").each(function(n,t){var i=r[$(t).data("source")],f=$(t).data("type");switch(f){case"date":i=new Date(i).toLocaleDateString()}u.append("<td data-type="+f+">"+i+"<\/td>")});i.append(u)})}function InitSortableTable(n){n.find("th").each(function(t,i){if($(i).hasClass("sortable"))$(i).on("click",function(){sortTable(n,t)})})}function sortTable(n,t){for(var r,i,o,s,e,h=0,c,u=!0,f="asc";u;){for(u=!1,r=n.find("tr"),i=1;i<r.length-1;i++)if(e=!1,o=$(r[i]).children("td")[t],s=$(r[i+1]).children("td")[t],c=$(o).data("type"),xValue=o.innerHTML.toLowerCase(),yValue=s.innerHTML.toLowerCase(),c=="int"&&(xValue=parseInt(xValue),yValue=parseInt(yValue)),f=="asc"){if(xValue>yValue){e=!0;break}}else if(f=="desc"&&xValue<yValue){e=!0;break}e?(r[i].parentNode.insertBefore(r[i+1],r[i]),u=!0,h++):h==0&&f=="asc"&&(f="desc",u=!0)}}$(document).on("ready",function(){function o(){if(n=$(".game"),n){u=$("<span class='game-button'>NEW GAME<\/span>");u.on("click",v);n.append(u)}}function v(){var t;u.remove();t=$("<input type='text' id='txtUsername' name='txtUsername' class='game-input' placeholder='Username' />");f&&t.val(f);var r=$("<select id='cboDifficulty' name='cboDifficulty' class='game-input' />").append($("<option value=1>Easy<\/option>"),$("<option value=2>Normal<\/option>"),$("<option value=3>Hard<\/option>")),i=$("<span class='game-button'>START GAME<\/span>"),e=$("<div class='message'> <\/div>");i.on("click",s);t.on("keydown",function(n){13===n.keyCode&&s(n)});n.append(t);n.append(r);n.append(i);n.append(e)}function s(){var i=$("#txtUsername").val(),u=$("#cboDifficulty").val();if(e=$("#cboDifficulty option:selected").text(),$(".message").empty(),!i){$(".message").html($("<span>Username required<\/span>"));return}n.empty();$.ajax({url:"/api/NewGame",data:{username:i,difficulty:u},success:function(n){t=n.user;r(n);f=i}})}function y(){var n=$("<div class='keyboard' />");return n.append($("<span class='keyboard-info'>Keyboard controls<\/span>"),$("<span class='keyboard-north'> - NORTH<\/span>"),$("<span class='keyboard-west'> - WEST<\/span>"),$("<span class='keyboard-east'> - EAST<\/span>"),$("<span class='keyboard-south'> - SOUTH<\/span>"),$("<span class='keyboard-attack'> - ATTACK<\/span>"),$("<span class='keyboard-heal'> - USE HEAL POTION<\/span>"),$("<span class='keyboard-toxic'> - ATTACK WITH TOXIC POTION<\/span>")),n}function p(n){var t=$("<div class='controls' />"),r,u,f;t.append(y());switch(n.fullMap.currentAction){case 1:case 2:r=$("<span class='game-button attack'>ATTACK<\/span>");r.on("click",h);break;case 3:return t;case 4:return t}var e=$("<span class='game-button north'>NORTH<\/span>"),o=$("<span class='game-button west'>WEST<\/span>"),s=$("<span class='game-button east'>EAST<\/span>"),a=$("<span class='game-button south'>SOUTH<\/span>");e.on("click",function(){i("N")});o.on("click",function(){i("W")});s.on("click",function(){i("E")});a.on("click",function(){i("S")});if(r){if(t.append($("<div />").append(r)),n.fullMap.currentAction==1&&n.fullMap.currentPlayer.toxicPotions>0){u=$("<span class='game-button attack'>ATTACK WITH TOXIC POTION<\/span>");u.on("click",c);t.append($("<div />").append(u))}}else t.append(e),t.append(o),t.append(s),t.append(a);if(n.fullMap.currentPlayer.healingPotions>0){f=$("<span class='game-button heal'>USE HEALING POTION<\/span>");f.on("click",l);t.append($("<div />").append(f))}return t}function h(){$.ajax({url:"/api/Attack",method:"POST",data:{user:t},success:function(i){n.empty();t=i.user;r(i)}})}function c(){$.ajax({url:"/api/AttackWithPotion",method:"POST",data:{user:t},success:function(i){n.empty();t=i.user;r(i)}})}function l(){$.ajax({url:"/api/Heal",method:"POST",data:{user:t},success:function(i){n.empty();t=i.user;r(i)}})}function w(n){var t=$("<div class='info' />"),i;t.append($("<span class='username'>"+n.fullMap.currentPlayer.username+"<\/span>"));t.append($("<span class='lives'>"+n.fullMap.currentPlayer.lives+"x <\/span>"));t.append($("<span class='score'>"+n.fullMap.currentPlayer.score+"<\/span>"));i="Walk";switch(n.fullMap.currentAction){case 1:i="Attack monster";break;case 2:i="Attack The boss";break;case 3:return t.append($("<span class='game-over'>GAME OVER<\/span>")),t.append(a()),t;case 4:return t.append($("<span class='game-win'>YOU WON<\/span>")),t.append(a()),t}return t.append($("<span class='action'>"+i+"<\/span>")),n.fullMap.currentMonster&&t.append($("<span class='monster-lives'>"+n.fullMap.currentMonster.lives+"x <\/span>")),t.append($("<span class='healing-potions'>"+n.fullMap.currentPlayer.healingPotions+"x <\/span>")),t.append($("<span class='toxic-potions'>"+n.fullMap.currentPlayer.toxicPotions+"x <\/span>")),t}function i(i){$.ajax({url:"/api/Move",method:"POST",data:{user:t,direction:i},success:function(i){n.empty();t=i.user;r(i)}})}function r(t){var u=t.map,i=$("<div class='map "+e.toLowerCase()+"' />"),f=u.split("\r\n"),r="";switch(t.fullMap.currentAction){case 1:r="monster";break;case 2:r="boss";break;case 3:r="gameover";break;case 4:r="win";break;case 5:r="visited";break;case 6:r="healing";break;case 7:r="toxic"}f.forEach(function(n){n.split("").forEach(function(n){switch(n){case"P":i.append($("<div class='player "+r+"' />"));break;case"B":i.append($("<div class='boss' />"));break;case"M":i.append($("<div class='monster' />"));break;case"H":i.append($("<div class='healing' />"));break;case"T":i.append($("<div class='toxic' />"));break;case"V":i.append($("<div class='visited' />"));break;case" ":i.append($("<div class='empty' />"))}})});n.append(w(t));n.append(i);n.append(p(t))}function a(){var t=$('<span class="game-button button-playagain">PLAY AGAIN<\/span>');t.on("click",function(){n.empty();o()});return t}var f,n,u,e,t;$("#btnUpdate").on("click",function(){var n=$("#txtUsernameOld").val(),t=$("#txtUsernameNew").val();$.ajax({url:"/api/Username",method:"PUT",data:{username:n,newUsername:t},success:function(){RefreshTable($("#tblScores"));$("#txtUsernameOld").val("");$("#txtUsernameNew").val("")}})});$("#btnDelete").on("click",function(){var n=$("#txtUsernameDelete").val();$.ajax({url:"/api/Scores",method:"DELETE",data:{username:n},success:function(){RefreshTable($("#tblScores"));$("#txtUsernameDelete").val("")}})});$("#btnSearch").on("click",function(){var n=$("#txtUsernameFilter").val(),t=$("#tblScores"),i="/api/scores/";n&&(i+="?username="+n);t.attr("data-url",i);RefreshTable(t)});$(document).on("keydown",function(n){switch(n.which){case 32:h();break;case 37:i("W");break;case 38:i("N");break;case 39:i("E");break;case 40:i("S");break;case 72:l();break;case 84:c();break;default:return}n.preventDefault()});o();InitTables()});